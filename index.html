<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>ポルテ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="icon" type="image/png" href="porte3.png" />
  <link rel="apple-touch-icon" href="porte3.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#000000">
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: black;
      font-family: sans-serif;
    }

    video {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100vw;
      max-height: 100vh;
      object-fit: contain;
      opacity: 0;
      z-index: 1;
      pointer-events: none;
      transition: opacity 0.05s;
    }

    video.active {
      opacity: 1;
      z-index: 10;
    }

    .footer {
      position: absolute;
      top: 10%;
      width: 100%;
      text-align: center;
      z-index: 100;
    }

    button {
      font-size: 1.2em;
      padding: 15px 25px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border: 2px solid white;
      cursor: pointer;
    }

    #static-image,
    #p2-image,
    #p4-image {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100vw;
      max-height: 100vh;
      z-index: 5;
    }

    #p2-image,
    #p4-image {
      display: none;
      z-index: 30;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>

  <img id="static-image" src="porte1.png">
  <img id="p2-image" src="porte2.png">
  <img id="p4-image" src="porte4.png">

  <div id="video-container">
    <video id="p1-v" src="p1.mp4" playsinline muted preload="auto"></video>
    <video id="p1rev-v" src="p1rev.mp4" playsinline muted preload="auto"></video>
    <video id="p2-v" src="p2.mp4" playsinline muted preload="auto"></video>
    <video id="p3-v" src="p3.mp4" playsinline muted preload="auto"></video>
    <video id="p4-v" src="p4.mp4" playsinline muted preload="auto"></video>
    <video id="p5-v" src="p5.mp4" playsinline muted preload="auto"></video>
    <video id="p6-v" src="p6.mp4" playsinline muted preload="auto"></video>
    <video id="p7-v" src="p7.mp4" playsinline muted preload="auto"></video>
    <video id="p8-v" src="p8.mp4" playsinline muted preload="auto"></video>
    <video id="p9-v" src="p9.mp4" playsinline muted preload="auto"></video>
    <video id="p10-v" src="p10.mp4" playsinline muted preload="auto" loop></video>
    <video id="p11-v" src="p11.mp4" playsinline muted preload="auto"></video>
    <video id="p12-v" src="p12.mp4" playsinline muted preload="auto"></video>
    <video id="p13-v" src="p13.mp4" playsinline muted preload="auto"></video>
    <video id="p14-v" src="p14.mp4" playsinline muted preload="auto"></video>
    <video id="p15-v" src="p15.mp4" playsinline muted preload="auto"></video>
    <video id="p16-v" src="p16.mp4" playsinline muted preload="auto"></video>
    <video id="p17-v" src="p17.mp4" playsinline muted preload="auto"></video>
    <video id="p18-v" src="p18.mp4" playsinline muted preload="auto"></video>
    <video id="p19-v" src="p19.mp4" playsinline muted preload="auto"></video>
    <video id="p20-v" src="p20.mp4" playsinline muted preload="auto"></video>
    <video id="p21-v" src="p21.mp4" playsinline muted preload="auto"></video>
    <video id="p22-v" src="p22.mp4" playsinline muted preload="auto"></video>
    <video id="p23-v" src="p23.mp4" playsinline muted preload="auto"></video>
    <video id="p24-v" src="p24.mp4" playsinline muted preload="auto"></video>
    <video id="p25-v" src="p25.mp4" playsinline muted preload="auto"></video>
    <video id="p26-v" src="p26.mp4" playsinline muted preload="auto"></video>
  </div>

  <div class="footer">
    <button id="start-btn">▶ ポルテ おこしてね</button>
  </div>

  <script>
    const btn = document.getElementById("start-btn");
    const staticImg = document.getElementById("static-image");
    const p2Img = document.getElementById("p2-image");
    const p4Img = document.getElementById("p4-image");
    const allVideos = Array.from(document.querySelectorAll('video'));

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const soundBuffers = {};

    async function loadSound(name, url) {
      try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        soundBuffers[name] = await audioCtx.decodeAudioData(arrayBuffer);
      } catch (e) { console.error("Sound load error:", name, e); }
    }

    // 音声ファイルのロード
    loadSound('p2', 'p2.mp3');
    loadSound('p3', 'p3.mp3');
    loadSound('p4', 'p4.mp3'); // p4を読み込み

    function playSound(name) {
      if (!soundBuffers[name]) return;
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const source = audioCtx.createBufferSource();
      source.buffer = soundBuffers[name];
      source.connect(audioCtx.destination);
      source.start(0);
      console.log("Audio Play:", name);
    }

    let activeKey = "";
    let isListening = false;
    let waitingKeywords = true;
    let p10VoiceTimer = null; // タイマー管理用変数

    // --- タイマー開始・停止関数 ---
    function startP10Timer() {
      stopP10Timer(); // 重複を防ぐために一度クリア
      console.log("Timer Started: 2分ごとに p4.mp3 を再生します");
      p10VoiceTimer = setInterval(() => {
        if (activeKey === "p10") {
          playSound('p4');
        }
      }, 5000); // 2分 (120,000ms)
    }

    function stopP10Timer() {
      if (p10VoiceTimer) {
        console.log("Timer Stopped");
        clearInterval(p10VoiceTimer);
        p10VoiceTimer = null;
      }
    }

    // --- コマンドリスト ---
    const k_wake = /ぽるて|ポルテ|ぽーちゃん|ぽおちゃん|ぽうちゃん|ポーちゃん|おーちゃん|フォーちゃん|こうちゃん|父ちゃん|ふぉるて|フォルテ|来れて|これて|取れて|とれて|降りて|おりて|ポチャン|ぽちゃん/i;
    const commands = [
      { rex: /おて|お手|大手|おては|お手は|大手は/i, vid: "p9" },
      { rex: /またね|おやすみ/i, vid: "p1rev" },
      { rex: /返事|へんじ|お返事|おへんじ/i, vid: "p3" },
      { rex: /もう一回|もういっかい|もう1回/i, vid: "p2" },
      { rex: /かわいい|可愛い/i, vid: "p13" },
      { rex: /なかよし|仲良し/i, vid: "p14" },
      { rex: /どうした|どうしたの/i, vid: "p15" },
      { rex: /だめ|ダメ|駄目/i, vid: "p16" },
      { rex: /おはよう|おはよー/i, vid: "p17" },
      { rex: /みず|水|おみず|お水/i, vid: "p18" },
      { rex: /ごはん|ご飯|ゴハン/i, vid: "p19" },
      { rex: /だっこ|ダッコ|抱っこ/i, vid: "p20" },
      { rex: /おかわり|おかわり|お変わり/i, vid: "p21" },
      { rex: /きて|来て|きて|着て/i, vid: "p22" },
      { rex: /おいで/i, vid: "p23" },
      { rex: /おきて/i, vid: "p24" },
      { rex: /はしる|走る/i, vid: "p25" },
      { rex: /じゃんぷ|ジャンプ/i, vid: "p26" },
      { rex: /ありがとう|ありがと|ごめん|ゴメン|ごめんよ|ゴメンよ|元気|げんき|ゲンキ|いいね|イイネー|いいねー|いいねえ|イイねえ|イイね|すごい|凄い|りこう|利口|お利口|おりこう|楽しい|おいしい|いいね|元気|好き|すき|スキ/i, vid: "p4" },
      { rex: /でかけ|出かけ|おでかけ|お出かけ|さんぽ|散歩|お散歩|おさんぽ|おやつ|いいでしょ|いいでしょう/i, vid: "p12" },
      { rex: /ちゅう|ちゅー|チュー|チュ|注|中/i, vid: "p5" },
      { rex: /どうぞ|食べて|たべて/i, vid: "p7" },
      { rex: /ちょうだい|頂戴/i, vid: "p8" },
      { rex: /かまって|構って|あそんで|遊んで|あそぶの|遊ぶの/i, vid: "p6" },
      { rex: /いくの|行くの|たべるの|食べるの|食べんの|たべんの|いきたい|行きたい|食べたい|たべたい/i, vid: "p11" }
    ];

    async function switchVideo(key) {
      const nextV = document.getElementById(key + "-v");
      if (!nextV || (activeKey === key && key === "p10")) return;

      activeKey = key;

      // タイマー管理：p10なら開始、それ以外なら停止
      if (key === "p10") {
        startP10Timer();
      } else {
        stopP10Timer();
      }

      if (key === 'p2' || key === 'p3') playSound(key);

      nextV.currentTime = 0;
      try {
        await nextV.play();
        nextV.classList.add('active');

        if (key === 'p1') staticImg.classList.add('hidden');
        p2Img.style.display = "none";
        p4Img.style.display = "none";

        setTimeout(() => {
          allVideos.forEach(v => {
            if (v !== nextV) {
              v.pause();
              v.classList.remove('active');
            }
          });
        }, 100);
      } catch (e) { console.error(e); }
    }

    allVideos.forEach(v => {
      v.onended = () => {
        const key = v.id.replace('-v', '');
        if (key === "p1rev") {
          stopP10Timer(); // おやすみしたらタイマーも停止
          staticImg.classList.remove('hidden');
          setTimeout(() => {
            v.classList.remove('active');
            activeKey = "";
            waitingKeywords = true;
          }, 100);
        } else if (key !== "p10") {
          switchVideo("p10");
        }
      };
    });

    function initRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.continuous = true;

      recognition.onresult = (event) => {
        const text = event.results[event.results.length - 1][0].transcript;
        let matched = false;

        if (waitingKeywords) {
          if (k_wake.test(text)) { switchVideo("p1"); waitingKeywords = false; matched = true; }
        } else {
          if (k_wake.test(text)) { switchVideo("p3"); matched = true; }
          else {
            for (const cmd of commands) {
              if (cmd.rex.test(text)) { switchVideo(cmd.vid); matched = true; break; }
            }
          }
          if (!matched && /どうしますか|どおしますか|どーしますか/i.test(text)) {
            p4Img.style.display = "block";
            setTimeout(() => { p4Img.style.display = "none"; switchVideo("p10"); }, 1200);
            matched = true;
          }
          if (!matched && activeKey === "p10") {
            p2Img.style.display = "block";
            setTimeout(() => { p2Img.style.display = "none"; }, 1200);
          }
        }
      };

      recognition.onend = () => { if (isListening) recognition.start(); };
      recognition.start();
    }

    btn.addEventListener("click", () => {
      isListening = true;
      btn.classList.add("hidden");
      if (audioCtx.state === 'suspended') audioCtx.resume();
      allVideos.forEach(v => { v.play().then(() => v.pause()).catch(() => {}); });
      initRecognition();
    });

    // ダブルクリック全画面機能
    document.addEventListener("dblclick", () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(() => {});
      } else {
        if (document.exitFullscreen) document.exitFullscreen();
      }
    });
  </script>
</body>

</html>